# PersonaForge - Telegram Bot with Human-like AI

## Цель проекта

Создать Telegram-бота на Rust, который ведет диалог "как реальный человек" в личных чатах и в группах/супергруппах, с настраиваемой персоной и памятью на базе RAG (Retrieval Augmented Generation), используя локальную Ollama, запущенную на хост-машине.

## Реализованный функционал (на текущий момент)

На данный момент реализован базовый каркас бота с ключевыми функциями для демонстрации основной концепции:

-   **Работа в личных чатах:** Бот отвечает на сообщения в личных чатах.
-   **Базовая генерация ответов:** Используется локальная модель Ollama для генерации ответов.
-   **Контекст диалога (short-term memory):** Бот поддерживает контекст последних N сообщений чата (в памяти).
-   **RAG-память:**
    -   Сохранение фактов/фрагментов диалога и/или заметок в локальной базе данных SQLite.
    -   Поиск релевантных фрагментов по embedding similarity (также через Ollama) и добавление их в контекст ответа.
-   **Персона:** Бот использует настраиваемую "манеру речи" через system prompt, который может быть загружен из базы данных.
-   **Docker-first:** Бот запускается в Docker-контейнере и подключается к Ollama, работающей на хосте.
-   **Надёжность:** Встроены базовые механизмы таймаутов на запросы к Ollama и примитивный rate limiting (cooldown) на основе настроек чата.
-   **Безопасность:** Запросы к Ollama обрабатываются с базовой логикой ошибок.
-   **Конфиденциальность:** Хранение данных настроено для локальной SQLite, что обеспечивает контроль над данными.

## Технологии

-   **Язык:** Rust
-   **Telegram SDK:** `teloxide`
-   **LLM:** Ollama (локально на хосте)
-   **База данных:** SQLite (через `sqlx`)
-   **Сериализация эмбеддингов:** `bincode`
-   **Асинхронность:** `tokio`
-   **Конфигурация:** `dotenv`, `envy`
-   **Логирование:** `pretty_env_logger`
-   **Контейнеризация:** Docker, `docker-compose`

## Настройка и запуск

Для запуска бота вам потребуется установленный Docker, Ollama и аккаунт в Telegram для создания бота.

### 1. Клонирование репозитория

```bash
git clone https://github.com/your-username/PersonaForge.git
cd PersonaForge
```

### 2. Создание Telegram-бота

1.  Откройте Telegram и найдите [@BotFather](https://t.me/BotFather).
2.  Отправьте ему команду `/newbot`.
3.  Следуйте инструкциям BotFather, чтобы создать нового бота и получить его токен. Сохраните этот токен.
4.  Получите ваш Telegram User ID, используя бота, например, [@userinfobot](https://t.me/userinfobot). Сохраните этот ID.

### 3. Настройка переменных окружения

Создайте файл `.env` в корневой директории проекта, скопировав `.env.example`:

```bash
cp .env.example .env
```

Затем отредактируйте файл `.env`, заполнив значения:

```ini
TELOXIDE_TOKEN=ВАШ_ТОКЕН_БОТА
DATABASE_URL=sqlite:persona_forge.db
OWNER_ID=ВАШ_TELEGRAM_USER_ID
OLLAMA_URL=http://host.docker.internal:11434 # URL для Ollama, запущенной на хосте
OLLAMA_CHAT_MODEL=gemini-3-flash-preview:cloud # Модель чата по умолчанию
OLLAMA_EMBEDDING_MODEL=nomic-embed-text # Модель для эмбеддингов по умолчанию
```

-   `TELOXIDE_TOKEN`: Токен, полученный от BotFather.
-   `DATABASE_URL`: Путь к файлу SQLite базы данных. `sqlite:persona_forge.db` по умолчанию создаст файл `persona_forge.db` в корне проекта.
-   `OWNER_ID`: Ваш Telegram User ID. Это необходимо для будущей панели владельца.
-   `OLLAMA_URL`: URL, по которому бот будет подключаться к Ollama. `http://host.docker.internal:11434` работает для Docker Desktop на Windows и macOS. Для Linux, если Ollama запущена на порту 11434, это может быть `http://172.17.0.1:11434` или IP вашей машины в Docker-сети.

### 4. Подготовка Ollama на хост-машине

1.  **Установите Ollama:** Следуйте инструкциям на [ollama.com](https://ollama.com/download) для вашей операционной системы.
2.  **Загрузите модели:** Откройте терминал и выполните следующие команды для загрузки моделей, которые будет использовать бот:
    ```bash
    ollama pull gemini-3-flash-preview:cloud
    ollama pull nomic-embed-text
    ```
    Это может занять некоторое время в зависимости от вашего интернет-соединения.
3.  **Запустите Ollama:** Убедитесь, что Ollama запущена и доступна на порту 11434. Обычно она запускается как фоновый сервис после установки.

### 5. Запуск бота

Выполните следующую команду в корневой директории проекта:

```bash
docker-compose up --build
```

-   `--build`: Обязателен при первом запуске или после изменений в коде Rust, чтобы пересобрать образ бота.

После успешного запуска бот будет готов к работе.

### 6. Взаимодействие с ботом

Просто отправляйте сообщения вашему боту в личных сообщениях. Он будет использовать Ollama для генерации ответов, основываясь на текущем контексте и своей RAG-памяти.

## Дальнейшие планы и TODO

Следующие шаги для развития проекта, частично основанные на изначальном ТЗ:

-   **Полная реализация Owner-панели:**
    -   ✅ CRUD для персон (создание, редактирование, активация).
    -   ✅ Выбор модели Ollama и параметров генерации (temperature, max tokens).
    -   ✅ Включение/выключение RAG и настройка глубины памяти.
    -   ✅ Просмотр статуса Ollama и БД.
-   **Полная реализация Админки чата:**
    -   ✅ Включение/выключение автоответов.
    -   ✅ Режим ответа: "только по упоминанию/команде" vs "на все сообщения".
    -   ✅ Настройки частоты ответов/антиспам (cooldown).
    -   ✅ Контекст (N последних сообщений в prompt).
-   **Улучшение "человечного" поведения:** Добавление правил, чтобы избежать повторений, раскрытия того, что это бот, аккуратное обращение с персональными данными.
-   **Улучшенное логирование и метрики:** Более детальное логирование, трассировка запросов, сбор метрик (время ответа, ошибки Ollama, нагрузка).
-   **Миграции БД:** Автоматическое применение миграций.
-   **Расширение RAG:** Развитие механизма "memory_chunks" для более гранулярного хранения и извлечения информации.
-   **Очереди/лимиты на генерацию:** Дополнительные механизмы для предотвращения перегрузки Ollama.
-   **Обработка ошибок:** БолееRobustная обработка ошибок для запросов к Ollama.

## Управление ботом

Владелец бота может использовать следующие команды:

### Главное меню
- `/menu` - Открыть главное меню с кнопками для управления ботом

### Управление персонами:
- `/create_persona название|описание` - Создать новую персону
- `/list_personas` - Показать все персоны
- `/activate_persona ID` - Активировать персону по ID
- `/update_persona ID|название|описание` - Обновить персону
- `/delete_persona ID` - Удалить персону по ID

### Настройки модели:
- `/set_model название` - Установить модель Ollama
- `/set_temperature значение` - Установить температуру (0.0-2.0)
- `/set_max_tokens значение` - Установить максимальное количество токенов

### Настройки RAG:
- `/enable_rag` - Включить RAG (поиск по памяти)
- `/disable_rag` - Отключить RAG (поиск по памяти)
- `/set_memory_depth значение` - Установить глубину памяти (1-50 сообщений)

### Настройки чата:
- `/enable_auto_reply` - Включить автоответы
- `/disable_auto_reply` - Отключить автоответы
- `/reply_to_all` - Отвечать на все сообщения
- `/reply_to_mention` - Отвечать только по упоминанию/команде
- `/set_cooldown значение` - Установить задержку между ответами (в секундах)

### Системная информация:
- `/status` - Показать статус бота и сервисов
- `/help` - Показать список всех команд

## Управление через меню с кнопками

Для более удобного управления ботом доступно главное меню с кнопками. Используйте команду `/menu`, чтобы открыть интерактивное меню, где вы сможете:

1. **Управление персонами** - создание, просмотр, активация и удаление персон
2. **Настройки модели** - выбор модели, температуры и максимального количества токенов
3. **Настройки RAG** - включение/отключение поиска по памяти и настройка глубины памяти
4. **Настройки чата** - управление автоответами, режимами ответа и задержками
5. **Просмотр статуса** - проверка состояния Ollama и базы данных

Меню предоставляет более удобный способ управления ботом по сравнению с использованием множества отдельных команд.

## Как изменить персону (промт) в боте

В боте PersonaForge реализована система управления персонами (промтами), которая позволяет владельцу бота создавать, редактировать, активировать и удалять различные персоны. Вот как это работает:

### 1. Создание новой персоны
- Используйте команду: `/create_persona Название|Описание_персоны`
- Пример: `/create_persona Джарвис|Ты умный помощник Илона Маска`
- После создания персона сохраняется в базе данных, но не активируется автоматически

### 2. Просмотр всех персон
- Используйте команду: `/list_personas`
- Покажет список всех созданных персон с их ID, названием, статусом (активна/неактивна) и описанием

### 3. Активация персоны
- Используйте команду: `/activate_persona ID`
- Пример: `/activate_persona 1`
- Только одна персона может быть активной в один момент времени
- После активации бот будет использовать промт этой персоны для генерации ответов

### 4. Изменение существующей персоны
- Используйте команду: `/update_persona ID|Новое_название|Новый_промт`
- Пример: `/update_persona 1|Новый_Джарвис|Ты улучшенный помощник Илона Маска`
- Можно изменить как название, так и промт персоны

### 5. Удаление персоны
- Используйте команду: `/delete_persona ID`
- Пример: `/delete_persona 1`
- Если удаляемая персона была активной, она автоматически деактивируется

### Техническая реализация:

- Персоны хранятся в таблице `personas` базы данных SQLite
- У каждой персоны есть поля: ID, название, промт и статус активности
- При обработке сообщений бот загружает активную персону из базы данных
- Промт активной персоны используется как системное сообщение в промпте для LLM
- Если активной персоны нет, используется стандартный промт по умолчанию

### Важно:
- Команды доступны только владельцу бота (указанному в настройках `owner_id`)
- При смене персоны изменения вступают в силу сразу для новых сообщений
- История чата сохраняется независимо от смены персоны

## Управление через меню с кнопками

Для более удобного управления ботом доступно главное меню с кнопками. Используйте команду `/menu`, чтобы открыть интерактивное меню, где вы сможете:

1. **Управление персонами** - создание, просмотр, активация и удаление персон
2. **Настройки модели** - выбор модели, температуры и максимального количества токенов
3. **Настройки RAG** - включение/отключение поиска по памяти и настройка глубины памяти
4. **Настройки чата** - управление автоответами, режимами ответа и задержками
5. **Просмотр статуса** - проверка состояния Ollama и базы данных

Меню предоставляет более удобный способ управления ботом по сравнению с использованием множества отдельных команд.
