# ğŸ—ï¸ ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

## ĞĞ±Ğ·Ğ¾Ñ€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Telegram (Bot API)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Admin Bot (teloxide)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Commands: /add_account, /list_accounts, /status     â”‚   â”‚
â”‚  â”‚  Dialogues: Phone â†’ Code â†’ 2FA â†’ Prompt              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AppState                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Config  â”‚  â”‚ Database â”‚  â”‚  Userbot Registry        â”‚  â”‚
â”‚  â”‚          â”‚  â”‚  (SQLx)  â”‚  â”‚  HashMap<id, Handle>     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Userbot Workers (MTProto)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Userbot 1   â”‚  â”‚  Userbot 2   â”‚  â”‚  Userbot N   â”‚      â”‚
â”‚  â”‚  (rust-tdlib)â”‚  â”‚  (rust-tdlib)â”‚  â”‚  (rust-tdlib)â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                 â”‚                 â”‚               â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                           â”‚                                 â”‚
â”‚                           â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              AI Core (Ollama + Whisper)            â”‚    â”‚
â”‚  â”‚  â€¢ Response generation                             â”‚    â”‚
â”‚  â”‚  â€¢ Voice transcription                             â”‚    â”‚
â”‚  â”‚  â€¢ Humanization (delays, typing)                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°

```
src/
â”œâ”€â”€ main.rs              # Entry point, admin bot dispatcher
â”œâ”€â”€ lib.rs               # Module exports
â”œâ”€â”€ config.rs            # Environment configuration
â”œâ”€â”€ state.rs             # AppState, userbot registry
â”‚
â”œâ”€â”€ bot/
â”‚   â”œâ”€â”€ mod.rs           # Admin bot setup, dialogue routing
â”‚   â”œâ”€â”€ handlers.rs      # Admin commands
â”‚   â”œâ”€â”€ dialogues.rs     # TDLib authentication flows
â”‚   â””â”€â”€ middleware.rs    # Owner verification
â”‚
â”œâ”€â”€ userbot/
â”‚   â”œâ”€â”€ mod.rs           # Userbot module exports
â”‚   â””â”€â”€ worker.rs        # MTProto event loop, humanization
â”‚
â”œâ”€â”€ ai/
â”‚   â”œâ”€â”€ mod.rs           # AI module exports
â”‚   â”œâ”€â”€ ollama.rs        # Ollama API client
â”‚   â””â”€â”€ whisper.rs       # Whisper API client
â”‚
â””â”€â”€ db/
    â”œâ”€â”€ mod.rs           # Database operations
    â”œâ”€â”€ models.rs        # Data models
    â””â”€â”€ repository.rs    # Repository pattern
```

## ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹

### AppState

Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ:

```rust
pub struct AppState {
    pub config: Config,
    pub db_pool: SqlitePool,
    pub http_client: reqwest::Client,
    pub llm_semaphore: Arc<Semaphore>,
    pub wizard_states: Arc<Mutex<HashMap<...>>>,
    pub triggers_cache: Arc<Mutex<HashMap<...>>>,
    // ...
}
```

### Handler Flow

```
Message â†’ Filter â†’ Handler â†’ Response
                      â”‚
                      â”œâ”€â”€ Check triggers
                      â”œâ”€â”€ Security check
                      â”œâ”€â”€ RAG retrieval
                      â”œâ”€â”€ LLM generation
                      â””â”€â”€ Send response
```

### Database Schema

```sql
-- ĞŸĞµÑ€ÑĞ¾Ğ½Ñ‹
personas (id, name, prompt, display_name, triggers, created_at)

-- ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ñ‡Ğ°Ñ‚Ğ¾Ğ²
chat_settings (chat_id, active_persona_id, rag_enabled, triggers, ...)

-- Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
messages (id, chat_id, user_id, role, content, created_at)

-- RAG Ğ¿Ğ°Ğ¼ÑÑ‚ÑŒ
memory_chunks (id, chat_id, content, embedding, importance, created_at)

-- Ğ¡ÑƒĞ¼Ğ¼Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
chat_summaries (id, chat_id, summary, message_count, created_at)

-- Runtime ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³
runtime_config (key, value, updated_at)
```

## ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹

### Async/Await

Ğ’ÑÑ‘ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾Ğµ Ñ‡ĞµÑ€ĞµĞ· Tokio:

```rust
async fn handle_message(msg: Message, state: AppState) -> Result<()> {
    let response = state.llm_client.generate(&prompt).await?;
    // ...
}
```

### Error Handling

`anyhow` Ğ´Ğ»Ñ application errors:

```rust
use anyhow::{Context, Result};

async fn do_something() -> Result<()> {
    let data = fetch_data()
        .await
        .context("Failed to fetch data")?;
    Ok(())
}
```

### Concurrency Control

Semaphore Ğ´Ğ»Ñ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ LLM Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²:

```rust
let _permit = state.llm_semaphore.acquire().await?;
// Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ MAX_CONCURRENT_LLM_REQUESTS Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾
let response = generate(&prompt).await?;
```

### State Sharing

`Arc<Mutex<>>` Ğ´Ğ»Ñ shared mutable state:

```rust
let mut cache = state.triggers_cache.lock().await;
cache.insert(chat_id, triggers);
```

## ĞŸĞ¾Ñ‚Ğ¾ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ â†’ ĞÑ‚Ğ²ĞµÑ‚

```
1. Telegram webhook/polling
2. teloxide dispatcher
3. Filter: is_relevant_message?
4. Security: check_injection()
5. RAG: retrieve_context()
6. LLM: generate_response()
7. Send: bot.send_message()
```

### Mini App â†’ API

```
1. Telegram WebApp opens
2. initData validation (HMAC)
3. Owner check
4. API request
5. Database query
6. JSON response
```

## Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ğµ

### Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²ÑƒÑ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ

1. `commands.rs`: Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ handler
2. `mod.rs`: Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞ¹ Ğ² dispatcher
3. Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾

### Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ API endpoint

1. `api.rs`: Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ handler
2. `server.rs`: Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ route
3. Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾

### Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²ÑƒÑ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ

1. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ: `migrations/YYYYMMDDHHMMSS_name.sql`
2. `db/mod.rs`: Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ queries
3. ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸ â€” Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸

---

â¡ï¸ Ğ”Ğ°Ğ»ĞµĞµ: [[API|REST API]]
